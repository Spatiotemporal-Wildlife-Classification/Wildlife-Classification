
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>Image Classification Modelling - Spatiotemporal Wildlife Classification Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.26e3688c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#image-classification-modelling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Spatiotemporal Wildlife Classification Docs" class="md-header__button md-logo" aria-label="Spatiotemporal Wildlife Classification Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Spatiotemporal Wildlife Classification Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Image Classification Modelling
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Spatiotemporal Wildlife Classification Docs" class="md-nav__button md-logo" aria-label="Spatiotemporal Wildlife Classification Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Spatiotemporal Wildlife Classification Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        Code Documentation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../dataset/" class="md-nav__link">
        Dataset
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../cascading_ensemble_classifier/" class="md-nav__link">
        Novel Cascading Ensemble Classifier
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../results/" class="md-nav__link">
        Results
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../thesis/" class="md-nav__link">
        Thesis report
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.models.image.taxonomic_modelling" class="md-nav__link">
    src.models.image.taxonomic_modelling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.models.image.taxonomic_modelling.construct_model" class="md-nav__link">
    construct_model()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.models.image.taxonomic_modelling.get_image_labels" class="md-nav__link">
    get_image_labels()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.models.image.taxonomic_modelling.import_dataset" class="md-nav__link">
    import_dataset()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.models.image.taxonomic_modelling.plot_hist" class="md-nav__link">
    plot_hist()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.models.image.taxonomic_modelling.setup_paths" class="md-nav__link">
    setup_paths()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.models.image.taxonomic_modelling.train_model" class="md-nav__link">
    train_model()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.models.image.taxonomic_modelling.train_model_top_weights" class="md-nav__link">
    train_model_top_weights()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="image-classification-modelling">Image Classification Modelling</h1>


<div class="doc doc-object doc-module">


<a id="src.models.image.taxonomic_modelling"></a>
  <div class="doc doc-contents first">
  
      <p>This file contains all methods needed to make, train, and evaluate the EfficientNet B6 model on the specified dataset.</p>
<p>This file requires manual specification of the taxonomic parent node to model. Due to the massive memory and computational
requirements of training a large CNN, only a single model can be trained at a time.</p>
<p>Please review the Animal-Detector repository to create the required image directories in order to train the models.</p>
<p>This training process is structured to be run within a Docker container in order to train on a single GPU unit.
Please review the documentation or README how to run the training and validation processes.
For easy access here is the command to run the model training:</p>
<pre><code>docker run --gpus all -u $(id -u):$(id -g) -v /path/to/project/root:/app/ -w /app -t ghcr.io/trav-d13/spatiotemporal_wildlife_classification/train_image:latest
</code></pre>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The saved name of the model. The file name must have the following format. taxonomic name + _taxon_classifier. Example: <code>lynx_lynx_taxon_classifier</code></p></td>
        </tr>
        <tr>
          <td><code>img_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the taxonomic parent node within the <code>taxon</code> directory. Example" <code>felidae/lynx/lynx_lynx/</code></p></td>
        </tr>
        <tr>
          <td><code>save_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to where the model will be saved. In this case the <code>models/image/</code> directory</p></td>
        </tr>
        <tr>
          <td><code>img_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The specified image size as input to the EfficientNet-B6 model (528)</p></td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of images within a single batch (32)</p></td>
        </tr>
        <tr>
          <td><code>epochs</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of epochs in model training (25)</p></td>
        </tr>
    </tbody>
  </table>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="src.models.image.taxonomic_modelling.construct_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">construct_model</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Method constructs an EfficientNet-B6 model to fit the specified number of classes.</p>
<p>The training makes use of transfer learning, so the EfficientNet-B6 model is created with ImageNet weights.
The top softmax layer is removed from the original model and replaced with a Global Average Pooling 2D Layer, followed
by a densely connected softmax layer classifying the specified number of classes.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>classes</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Integer specifying the number of classes to be classified. Instructs the size of the softmax output layer.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="keras.Model">Model</span></code>
          </td>
          <td><p>The complete model ready to be trained.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/models/image/taxonomic_modelling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">construct_model</span><span class="p">(</span><span class="n">classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Method constructs an EfficientNet-B6 model to fit the specified number of classes.</span>

<span class="sd">    The training makes use of transfer learning, so the EfficientNet-B6 model is created with ImageNet weights.</span>
<span class="sd">    The top softmax layer is removed from the original model and replaced with a Global Average Pooling 2D Layer, followed</span>
<span class="sd">    by a densely connected softmax layer classifying the specified number of classes.</span>

<span class="sd">    Args:</span>
<span class="sd">        classes (int): Integer specifying the number of classes to be classified. Instructs the size of the softmax output layer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (Model): The complete model ready to be trained.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Construct the expected image input</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">EfficientNetB6</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">input_tensor</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
                           <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;imagenet&#39;</span><span class="p">,</span>
                           <span class="n">drop_connect_rate</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># Initialize efficientnet model with imagenet weights</span>

    <span class="n">model</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Freeze the pre-trained weights</span>

    <span class="c1"># Rebuild the top layers</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;EfficientNet_Taxon_Classifier&#39;</span><span class="p">)</span>  <span class="c1"># Construct the entire model</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># Initialize optimizer</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>  <span class="c1"># Compile the model for use</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.models.image.taxonomic_modelling.get_image_labels" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_image_labels</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Method generates class names from the dataset. This helps generate class weightings</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>ds</code></td>
          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tensorflow.data.Dataset">Dataset</span></code>
          </td>
          <td><p>Either the train or test dataset which labels must be generated for.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>classes</code></td>
          <td>
                <code>list</code>
          </td>
          <td><p>A list of the class labels (alphabetically ordered).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list</code>
          </td>
          <td><p>A list of labels in the provided dataset, in the same order as specified in the dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/models/image/taxonomic_modelling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_image_labels</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">classes</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Method generates class names from the dataset. This helps generate class weightings</span>

<span class="sd">    Args:</span>
<span class="sd">        ds (tf.data.Dataset): Either the train or test dataset which labels must be generated for.</span>
<span class="sd">        classes (list): A list of the class labels (alphabetically ordered).</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list): A list of labels in the provided dataset, in the same order as specified in the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ohe_labels</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Container to hold the ohe encoded version of the labels</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Container to hold the categorical labels</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">ohe_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># Generate ohe encoded labels from dataset</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ohe_labels</span><span class="p">:</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>  <span class="c1"># Transform ohe labels into categorical labels</span>
    <span class="k">return</span> <span class="n">labels</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.models.image.taxonomic_modelling.import_dataset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">import_dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This method imports the dataset from the proposed directory forming both a train and test set.</p>
<p>This method uses the imaage_dataset_from_directory() method. For more information please visit:
https://www.tensorflow.org/api_docs/python/tf/keras/utils/image_dataset_from_directory</p>
<p>This method, allows specification of the file path and automatically determines the labels based on the directory
structure, hence the directory structure replicating the taxonomic tree of the dataset.
Additionally, the class names are dispayed when this method is called.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>file_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path from the <code>taxon/</code> (including) directory. Example: <code>taxon/felidae/lynx/lynx_lynx/</code></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>train_ds</code></td>          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tensorflow.data.Dataset">Dataset</span></code>
          </td>
          <td><p>The training dataset which will be used to train the model</p></td>
        </tr>
        <tr>
<td><code>val_ds</code></td>          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tensorflow.data.Dataset">Dataset</span></code>
          </td>
          <td><p>The testing dataset used to test the trained model.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/models/image/taxonomic_modelling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">import_dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method imports the dataset from the proposed directory forming both a train and test set.</span>

<span class="sd">    This method uses the imaage_dataset_from_directory() method. For more information please visit:</span>
<span class="sd">    https://www.tensorflow.org/api_docs/python/tf/keras/utils/image_dataset_from_directory</span>

<span class="sd">    This method, allows specification of the file path and automatically determines the labels based on the directory</span>
<span class="sd">    structure, hence the directory structure replicating the taxonomic tree of the dataset.</span>
<span class="sd">    Additionally, the class names are dispayed when this method is called.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path (str): The path from the `taxon/` (including) directory. Example: `taxon/felidae/lynx/lynx_lynx/`</span>

<span class="sd">    Returns:</span>
<span class="sd">        train_ds (tf.data.Dataset): The training dataset which will be used to train the model</span>
<span class="sd">        val_ds (tf.data.Dataset): The testing dataset used to test the trained model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">image_dataset_from_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                                            <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                                            <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;training&#39;</span><span class="p">,</span>
                                            <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
                                            <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span>
                                            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                            <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;inferred&#39;</span><span class="p">,</span>
                                            <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;categorical&#39;</span><span class="p">)</span>
    <span class="n">val_ds</span> <span class="o">=</span> <span class="n">image_dataset_from_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
                                          <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                                          <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">,</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
                                          <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">),</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                          <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;inferred&#39;</span><span class="p">,</span>
                                          <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;categorical&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_ds</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.models.image.taxonomic_modelling.plot_hist" class="doc doc-heading">
<code class="highlight language-python"><span class="n">plot_hist</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This method plots the accuracy and the validation set accuracy over the number of epochs and saves the figure.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>hist</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>A dictionary containing the training accuracy and testing accuracies per epoch</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/models/image/taxonomic_modelling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">plot_hist</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method plots the accuracy and the validation set accuracy over the number of epochs and saves the figure.</span>

<span class="sd">    Args:</span>
<span class="sd">        hist (dict): A dictionary containing the training accuracy and testing accuracies per epoch</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Accuracy (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epoch&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Train&quot;</span><span class="p">,</span> <span class="s2">&quot;Validation&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># Show the model</span>

    <span class="n">save_title</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>  <span class="c1"># Prepare the figure save name</span>
    <span class="n">save_title</span> <span class="o">=</span> <span class="n">save_title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">resources_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="n">save_title</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>  <span class="c1"># Save the figure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">resources_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.models.image.taxonomic_modelling.setup_paths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">setup_paths</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This method creates the correct file save and dataset access paths</p>
<p>This method directly modifies global path variables</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The file name must have the following format. taxonomic name + _taxon_classifier. Example: <code>lynx_lynx_taxon_classifier</code></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dataset_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the taxonomic parent node within the <code>taxon</code> directory. Example" <code>felidae/lynx/lynx_lynx/</code></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/models/image/taxonomic_modelling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setup_paths</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method creates the correct file save and dataset access paths</span>

<span class="sd">    This method directly modifies global path variables</span>

<span class="sd">    Args:</span>
<span class="sd">        file_name (str): The file name must have the following format. taxonomic name + _taxon_classifier. Example: `lynx_lynx_taxon_classifier`</span>
<span class="sd">        dataset_path (str): The path to the taxonomic parent node within the `taxon` directory. Example&quot; `felidae/lynx/lynx_lynx/`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">save_path</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">file_name</span>
    <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;taxon/&#39;</span> <span class="o">+</span> <span class="n">dataset_path</span><span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;models/image/&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.models.image.taxonomic_modelling.train_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train_model</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This model specifies the entire training process, and simplifies the model naming and dataset specification procedure for training.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>file_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The file name must have the following format. taxonomic name + _taxon_classifier. Example: <code>lynx_lynx_taxon_classifier</code></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dataset_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the taxonomic parent node within the <code>taxon</code> directory. Example" <code>felidae/lynx/lynx_lynx/</code></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>visualize</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>A boolean value indicating whether the training and testing over the number of epochs should be visualized and saved in a figure.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/models/image/taxonomic_modelling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model specifies the entire training process, and simplifies the model naming and dataset specification procedure for training.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_name (str): The file name must have the following format. taxonomic name + _taxon_classifier. Example: `lynx_lynx_taxon_classifier`</span>
<span class="sd">        dataset_path (str): The path to the taxonomic parent node within the `taxon` directory. Example&quot; `felidae/lynx/lynx_lynx/`</span>
<span class="sd">        visualize (bool): A boolean value indicating whether the training and testing over the number of epochs should be visualized and saved in a figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">setup_paths</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">)</span>  <span class="c1"># Setup the model save and dataset paths</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Num GPUs Available: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)))</span>  <span class="c1"># This will print out the number of GPU&#39;s available</span>

    <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span> <span class="o">=</span> <span class="n">import_dataset</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>  <span class="c1"># Import and generate dataset</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>  <span class="c1"># Number of classes</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">construct_model</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>  <span class="c1"># Construct the model</span>

    <span class="n">model</span><span class="p">,</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">train_model_top_weights</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">)</span>  <span class="c1"># Train the model&#39;s top weights</span>

    <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Attempt to plot and save visualization of training and test data</span>
            <span class="n">plot_hist</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="s2">&quot;Lynx Lynx Classification Training&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not enough training epochs to generate display&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="src.models.image.taxonomic_modelling.train_model_top_weights" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train_model_top_weights</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Perform CNN training on the unfrozen top weights of the model.</p>
<p>The dataset is weighted to achieve a balanced impact of each class on the model training.
This is used to combat the long-tail distribution of the dataset.
A best model save policy is created so only the best model from the training epochs is saved.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code><span title="keras.Model">Model</span></code>
          </td>
          <td><p>The crated and prepared EfficientNet-B6 model with all but the top layers frozen, for training on the provided dataset.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>train_ds</code></td>
          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tensorflow.data.Dataset">Dataset</span></code>
          </td>
          <td><p>The image training dataset</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>val_ds</code></td>
          <td>
                <code><span title="tensorflow">tf</span>.<span title="tensorflow.data">data</span>.<span title="tensorflow.data.Dataset">Dataset</span></code>
          </td>
          <td><p>The image test dataset</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>model</code></td>          <td>
                <code><span title="keras.Model">Model</span></code>
          </td>
          <td><p>The trained model</p></td>
        </tr>
        <tr>
<td><code>hist</code></td>          <td>
                <code>dict</code>
          </td>
          <td><p>The history of the model training process.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>src/models/image/taxonomic_modelling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_model_top_weights</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">train_ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform CNN training on the unfrozen top weights of the model.</span>

<span class="sd">    The dataset is weighted to achieve a balanced impact of each class on the model training.</span>
<span class="sd">    This is used to combat the long-tail distribution of the dataset.</span>
<span class="sd">    A best model save policy is created so only the best model from the training epochs is saved.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (Model): The crated and prepared EfficientNet-B6 model with all but the top layers frozen, for training on the provided dataset.</span>
<span class="sd">        train_ds (tf.data.Dataset): The image training dataset</span>
<span class="sd">        val_ds (tf.data.Dataset): The image test dataset</span>

<span class="sd">    Returns:</span>
<span class="sd">        model (Model): The trained model</span>
<span class="sd">        hist (dict): The history of the model training process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">class_names</span>   <span class="c1"># Create dataset weighting</span>
    <span class="n">weight_values</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span>
                                         <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span>
                                         <span class="n">y</span><span class="o">=</span><span class="n">get_image_labels</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">classes</span><span class="p">))</span>
    <span class="n">class_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">class_labels</span><span class="p">,</span> <span class="n">weight_values</span><span class="p">))</span>

    <span class="n">cp_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span>
                                                     <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span>
                                                     <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Create the best-model save policy through the use of a callback</span>

    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>  <span class="c1"># Prefetch both the train and test dataset to speed up training and evaluation</span>
    <span class="n">val_ds</span> <span class="o">=</span> <span class="n">val_ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">AUTOTUNE</span><span class="p">)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>  <span class="c1"># Specify training specifics. The calculation of steps and validation steps speeds up training</span>
    <span class="n">validation_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Due to varying dataset sizes, the conditionals determine if steps or validation steps are under 1 and correct for it.</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">validation_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">validation_steps</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Steps per epoch: &quot;</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation steps: &quot;</span><span class="p">,</span> <span class="n">validation_steps</span><span class="p">)</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span>
                     <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                     <span class="n">validation_data</span><span class="o">=</span><span class="n">val_ds</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                     <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">cp_callback</span><span class="p">],</span>
                     <span class="n">validation_steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">,</span>
                     <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
                     <span class="n">class_weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># Train the model and gather training history</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">hist</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.b4d07000.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>